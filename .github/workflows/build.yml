# Reusable workflow that builds and pushes/loads images to Nexus
name: Build and Push
on:
  workflow_dispatch:
    inputs:
      major:
        description: Major version
        required: true
        type: string
      minor:
        description: Minor version
        required: true
        type: string
      patch:
        description: Patch version
        required: true
        type: string

  secrets:
    DOCKERHUB_USERNAME:
      required: true
    DOCKERHUB_TOKEN:
      required: true

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            jackhrt/fluentd-docker
          # TODO - standard tags
          tags: |
            type=schedule
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{inputs.major}}
            type=semver,pattern={{inputs.major}}.{{inputs.minor}}
            type=semver,pattern={{inputs.major}}
            type=sha
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      # TODO - test before pushing
      # but how to test a different platform than the host
      -
        name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: jackhrt/fluentd-docker:tagname
          platforms: linux/amd64,linux/arm64
          cache-from: type=registry,ref=jackhrt/fluentd-docker:buildcache
          cache-to: type=registry,ref=jackhrt/fluentd-docker:buildcache,mode=max